name: build

on:
  push:
    branches:
      - master

  pull_request:

jobs:
  build:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v5

      - name: Find latest iOS Simulator destination (iPhone + iOS)
        id: destination
        run: |
          # Get the latest available iOS runtime (e.g., iOS 18.2)
          runtime=$(xcrun simctl list runtimes | grep -E "iOS [0-9]+\.[0-9]+" | grep -v unavailable | sort -rV | head -n 1)
          ios_version=$(echo "$runtime" | grep -oE "[0-9]+\.[0-9]+")
          echo "Latest iOS version: $ios_version"

          # Find latest available iPhone device supporting this runtime
          device=$(xcrun simctl list devices | grep -E "iPhone [0-9]+" | grep "iOS $ios_version" | grep -v unavailable | sort -rV | head -n 1 | cut -d '(' -f 1 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          echo "Selected device: $device"

          # Output final destination string for xcodebuild
          echo "destination=platform=iOS Simulator,OS=$ios_version,name=$device" >> $GITHUB_OUTPUT

      - name: Run Swift package tests
        run: swift test

      - name: Install CocoaPods dependencies
        run: |
          cd PersonnummerExample
          pod install

      - name: Build and test iOS project
        run: |
          cd PersonnummerExample
          xcodebuild clean test \
            -workspace PersonnummerExample.xcworkspace \
            -scheme PersonnummerExample \
            -destination "${{ steps.destination.outputs.destination }}" \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO ONLY_ACTIVE_ARCH=NO